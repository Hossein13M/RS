<div class="tw-w-screen-80">
    <div [title]="isUpdate() ? 'تغییر' : 'ایجاد'" appDialogHeader>
        <mat-icon (click)="this.dialogRef.close()" class="icon-header">close</mat-icon>
    </div>
    <mat-horizontal-stepper *ngIf="isUpdate() ? userData : true" class="tw-p-12" dir="rtl" #stepper="matHorizontalStepper" linear>
        <mat-step>
            <ng-template matStepLabel>اطلاعات پایه</ng-template>
            <form [formGroup]="form" class="tw-grid tw-grid-cols-3 tw-gap-7 tw-flex-wrap tw-pt-12" dir="rtl">
                <mat-form-field appearance="outline">
                    <mat-label>نام کاربری</mat-label>
                    <input formControlName="username" matInput required />
                    <mat-hint>نام کاربری باید غیر تکراری باشد.</mat-hint>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>نام</mat-label>
                    <input formControlName="firstname" matInput required />
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>نام خانوادگی</mat-label>
                    <input formControlName="lastname" matInput required />
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>کد ملی</mat-label>
                    <input formControlName="nationalCode" matInput required />
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>شماره همراه</mat-label>
                    <input formControlName="phoneNumber" matInput required />
                    <mat-hint>مثال: 09XXXXXXXXX</mat-hint>
                    <mat-error>شماره همراه باید با 09 شروع شود و 11 رقم باشد.</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>ایمیل</mat-label>
                    <input formControlName="email" matInput required />
                    <mat-hint>مثال: example@gmail.com</mat-hint>
                    <mat-error>لطفا ایمیل درستی را وارد کنید.</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>تاریخ تولد</mat-label>
                    <input [matDatepicker]="picker" formControlName="birthDate" matInput required />
                    <mat-datepicker-toggle [for]="picker" matSuffix></mat-datepicker-toggle>
                    <mat-datepicker #picker></mat-datepicker>
                </mat-form-field>

                <div class="tw-col-span-3">
                    <button color="primary" mat-raised-button matStepperNext>بعدی</button>
                </div>
            </form>
        </mat-step>

        <mat-step [stepControl]="form">
            <ng-template matStepLabel>چینش سازمانی</ng-template>
            <form [formGroup]="form" class="tw-mt-12" dir="rtl">
                <div class="form tw-flex tw-flex-col tw-gap-7 tw-overflow-auto tw-pl-5">
                    <div formArrayName="userRoles" *ngFor="let groupForm of userOrganizations.controls; let index = index" class="tw-w-full">
                        <div [formGroupName]="index" class="tw-grid tw-grid-cols-2 tw-gap-7">
                            <div class="tw-col-span-2 tw-flex tw-justify-between tw-align-center">
                                <h2 class="tw-m-0">چینش سازمانی: {{ index + 1 }}</h2>
                                <button *ngIf="this.userOrganizationControlsData.length > 1" (click)="deleteOrganization(index)" color="warn" mat-flat-button type="button">
                                    حذف چینش سازمانی <mat-icon>delete</mat-icon>
                                </button>
                            </div>

                            <mat-form-field appearance="outline">
                                <mat-label>کد پرسنلی</mat-label>
                                <input formControlName="personnelCode" matInput required />
                                <mat-error>کد پرسنلی اجباری میباشد.</mat-error>
                            </mat-form-field>

                            <mat-form-field appearance="outline">
                                <mat-label>نهاد</mat-label>
                                <mat-select formControlName="organizationCode" required>
                                    <ngx-mat-select-search
                                        class="tw-text-right"
                                        [noEntriesFoundLabel]="'یافت نشد'"
                                        [placeholderLabel]="'جستجو'"
                                        [formControl]="userOrganizationControlsData[index].organizationsSearchControl"
                                    ></ngx-mat-select-search>
                                    <mat-option
                                        class="tw-text-right"
                                        [value]="organize.code"
                                        *ngFor="let organize of userOrganizationControlsData[index].organizations"
                                    >
                                        {{ organize.name }}
                                    </mat-option>
                                </mat-select>
                                <mat-error>نهاد اجباری میباشد.</mat-error>
                            </mat-form-field>

                            <div *ngIf="userOrganizationControlsData[index].units">
                                <app-tree-select
                                    [maxSelect]="userOrganizationControlsData[index].units.children.length === 0 ? 0 : -1"
                                    [data]="userOrganizationControlsData[index].units"
                                    formControlName="units"
                                    selectedValueFieldName="name"
                                ></app-tree-select>
                            </div>

                            <mat-form-field appearance="outline" *ngIf="userOrganizationControlsData[index].roles.length > 0">
                                <mat-label>نقش</mat-label>
                                <mat-select formControlName="roles" multiple required>
                                    <mat-option
                                        class="tw-text=right"
                                        *ngFor="let role of userOrganizationControlsData[index].roles"
                                        [value]="role.id"
                                    >
                                        {{role.name}}
                                    </mat-option>
                                </mat-select>
                                <mat-error *ngIf="groupForm.get('units').hasError('required')">واحد اجباری میباشد.</mat-error>
                            </mat-form-field>
                        </div>
                    </div>
                    <button (click)="addOrganization()" class="tw-w-full" color="accent" mat-flat-button type="button">
                        افزودن چینش سازمانی<mat-icon>add</mat-icon>
                    </button>
                </div>

                <div class="tw-mt-10">
                    <button class="tw-ml-5" color="primary" mat-raised-button matStepperPrevious>قبلی</button>
                    <button color="warn" mat-raised-button (click)="onSubmit()">ثبت کاربر</button>
                </div>
            </form>
        </mat-step>
    </mat-horizontal-stepper>
</div>
